---
type Props = {
  href?: string;
  fallback?: string;
}

const { href, fallback = "/" } = Astro.props;
---
 
<button 
  class="back-button relative group w-fit flex pl-7 pr-3 py-1.5 flex-nowrap rounded border border-black/15 dark:border-white/20 hover:bg-black/5 dark:hover:bg-white/5 hover:text-black dark:hover:text-white transition-colors duration-300 ease-in-out cursor-pointer"
  data-href={href}
  data-fallback={fallback}
  onclick="handleBackClick(this)"
>
  <svg 
    xmlns="http://www.w3.org/2000/svg" 
    viewBox="0 0 24 24"
    class="absolute top-1/2 left-2 -translate-y-1/2 size-4 stroke-2 fill-none stroke-current">
    <line x1="5" y1="12" x2="19" y2="12" class="translate-x-2 group-hover:translate-x-0 scale-x-0 group-hover:scale-x-100 transition-transform duration-300 ease-in-out" />
    <polyline points="12 5 5 12 12 19" class="translate-x-1 group-hover:translate-x-0 transition-transform duration-300 ease-in-out" />
  </svg>
  <div class="text-sm">
    <slot/>
  </div>
</button>

<script is:inline>
  function handleBackClick(button) {
    console.log('Back button clicked');
    
    const currentUrl = new URL(window.location.href);
    const currentPage = currentUrl.origin + currentUrl.pathname;
    
    // 計算需要回退多少步來找到不同頁面
    function findDifferentPage() {
      // 檢查多個歷史步驟，找到第一個不同頁面
      let maxSteps = Math.min(10, window.history.length - 1);
      
      // 使用遞迴方式嘗試不同步數
      function trySteps(steps) {
        if (steps > maxSteps) {
          // 找不到不同頁面，使用 fallback
          console.log('No different page found, using fallback');
          const fallback = button.getAttribute('data-fallback') || '/';
          const href = button.getAttribute('data-href') || fallback;
          window.location.href = href;
          return;
        }
        
        // 先保存當前狀態
        const originalUrl = window.location.href;
        
        // 設置一個檢查點
        function checkAfterNavigation() {
          const newUrl = new URL(window.location.href);
          const newPage = newUrl.origin + newUrl.pathname;
          
          if (newPage !== currentPage) {
            console.log(`Found different page after ${steps} steps:`, window.location.href);
            // 找到了不同頁面，停留在這裡
            return;
          } else {
            // 還是同一頁面，繼續嘗試更多步驟
            console.log(`Still same page after ${steps} steps, trying ${steps + 1}`);
            trySteps(steps + 1);
          }
        }
        
        // 監聽導航完成
        function onPopState() {
          window.removeEventListener('popstate', onPopState);
          setTimeout(checkAfterNavigation, 0); // 確保 URL 已更新
        }
        
        window.addEventListener('popstate', onPopState);
        window.history.go(-steps);
      }
      
      // 開始嘗試，從 1 步開始
      trySteps(1);
    }
    
    // 如果有足夠的歷史記錄，開始尋找
    if (window.history.length > 1) {
      findDifferentPage();
    } else {
      // 沒有歷史記錄，直接使用 fallback
      console.log('No history available, using fallback');
      const fallback = button.getAttribute('data-fallback') || '/';
      const href = button.getAttribute('data-href') || fallback;
      window.location.href = href;
    }
  }
</script>
